<!doctype html>
<html>
 <head>
  <meta charset="utf-8">
  <meta name="Keywords" content="">
  <meta name="Description" content="">
  <link rel="stylesheet" href="style.css" />
  <script src="jq.js"></script>
  <title>Document</title>
 </head>
 <body>
    <div class="con">
        <div class="border title"><h1></h1></div>
        <div class="border map"></div>
        <div class="border message">
             <p class="_11">HP:<span></span></p>
             <p class="_22">ATK:<span></span></p>
             <p class="_33">DEF:<span></span></p>
             <p class="_44">GOLD:<span></span></p>
            <div class="key1"></div><p class="_1">X <span></span></p>
            <div class="key2"></div><p class="_2">X <span></span></p>
            <div class="key3"></div><p class="_3">X <span></span></p>
        </div>
    </div>
<script>
    $(function(){
        var game={
            exe:function(){
                this.draw_map();
            },
            floor:1,
            pcAttr:[100,10,10,0],
            pc_postion:[3,7],
            prevkey:0,
            gw:[[25,11,5,2],[45,12,6,5],[60,15,8,10]],
            onoff:true,
            map:[
                1,1,1,1,1,1,1,1,1,1,
                1,0,0,1,8,8,0,0,0,1,
                1,1,3,1,8,0,6,0,0,1,
                1,12,0,4,8,0,0,6,0,1,
                1,0,13,8,8,10,0,7,0,1,
                1,0,0,0,9,5,8,7,0,1,
                1,0,11,8,5,0,0,0,0,1,
                1,0,14,0,0,0,1,2,1,1,
                1,0,0,0,0,15,1,0,0,1,
                1,1,1,1,1,1,1,1,1,1
            ],
            draw_map:function(){
                $(".map").empty();
                var pc=$("<div class='pc'></div>")
                $(".map").append(pc);
                pc.css({left:this.pc_postion[0]*50,top:this.pc_postion[1]*50})
                for(var i=0;i<this.map.length;i++){
                   if(this.map[i]!=0){
                        var class_name;
                        if(this.map[i]==1)class_name="wall";
                        if(this.map[i]==2)class_name="door1";
                        if(this.map[i]==3)class_name="door2";
                        if(this.map[i]==4)class_name="door3";
                        if(this.map[i]==5)class_name="key1";
                        if(this.map[i]==6)class_name="key2";
                        if(this.map[i]==7)class_name="key3";
                        if(this.map[i]==8)class_name="gw1";
                        if(this.map[i]==9)class_name="gw2";
                        if(this.map[i]==10)class_name="gw3";
                        if(this.map[i]==11)class_name="addhp";
                        if(this.map[i]==12)class_name="addatk";
                        if(this.map[i]==13)class_name="adddef";
                        if(this.map[i]==14)class_name="down";
                        if(this.map[i]==15)class_name="up";
                        var dom=$('<div class='+class_name+'></div>');
                        $(".map").append(dom);
                        dom.css({
                            "left":(i%10)*50,
                            "top":parseInt(i/10)*50
                        })
                    }
                }
                $(".map .gw1").attr("attr",this.gw[0]);
                $(".map .gw2").attr("attr",this.gw[1]);
                $(".map .gw3").attr("attr",this.gw[2]);
                $(".title h1").text("第"+this.floor+"层");
                $(document).bind("keydown",game.pcmove);
                this.draw_message();
            },
            pcmove:function(e){
                var keycode=e.keyCode,top=$(".pc").position().top/50,left=$(".pc").position().left/50;
                if(game.onoff){
                    game.prevkey=keycode;
                    switch(keycode){
                        case 38:top--;
                        break;
                        case 40:top++;
                        break;
                        case 37:left--;
                        break;
                        case 39:left++;
                        break;
                    }
                    switch(game.map[top*10+left]){
                        case 1:prev_position();
                        break;
                        case 2:subkey(0);
                        break;
                        case 3:subkey(1);
                        break;
                        case 4:subkey(2);
                        break;
                        case 5:addkey(0);
                        break;
                        case 6:addkey(1);
                        break;
                        case 7:addkey(2);
                        break;
                        case 8:pz_gw();
                        break;
                        case 9:pz_gw();
                        break;
                        case 10:pz_gw();
                        break;
                        case 11:pz_hp();
                        break;
                        case 12:pz_atk();
                        break;
                        case 13:pz_def();
                        break;
                        case 14:down();
                        break;
                        case 15:up();
                        break;
                    }
                    $(".pc").css({"left":left*50,"top":top*50});
                }
                function pz_gw(){
                    game.onoff=false;
                    var delay_time=0;
                    var gwAttr=$(".map").children().eq(getIndex()).attr("attr").split(",");
                    for(var i=0;i<gwAttr.length;i++){
                        gwAttr[i]=Number(gwAttr[i]);
                    }
                    for(var i=0;i<100;i++){
                        delay_time+=100;
                        setTimeout(function(){
                             if(game.map[top*10+left]==8||game.map[top*10+left]==9||game.map[top*10+left]==10){
                                var lower=game.pcAttr[2]-gwAttr[1];
                                if(lower>0)lower=0;
                                var lower1=gwAttr[2]-game.pcAttr[1];
                                if(lower1>0)lower1=0;
                                game.pcAttr[0]+=lower;
                                gwAttr[0]+=lower1;
                                game.draw_message();
                                if(gwAttr[0]<=0){
                                     game.pcAttr[3]+=gwAttr[3];
                                     game.draw_message();
                                     removePz();
                                     game.onoff=true;
                                }
                                if(game.pcAttr[0]<=0){
                                     alert("YOU DIE");
                                }
                            }
                        },delay_time);
                    }

                }
                function prev_position(){
                   switch(keycode){
                        case 38:top++;
                        break;
                        case 40:top--;
                        break;
                        case 37:left++;
                        break;
                        case 39:left--;
                        break;
                   }
                }
                function addkey(index){
                    var value=game.keypack[index]+1;
                    game.keypack[index]=value;
                    game.draw_message();
                    removePz()
                }
                function subkey(index){
                    if(game.keypack[index]<1){
                        prev_position();
                    }
                    else{
                        var value=game.keypack[index]-1;
                        game.keypack[index]=value;
                        game.draw_message();
                        removePz();
                   }
                }
                function pz_hp(){
                    game.pcAttr[0]+=50;
                    game.draw_message();
                    removePz();
                };
                function pz_atk(){
                    game.pcAttr[1]+=3;
                    game.draw_message();
                    removePz();
                };
                function pz_def(){
                    game.pcAttr[2]+=3;
                    game.draw_message();
                    removePz();
                };
                 function getIndex(){
                    var num=0;
                    for(var i=0;i<top*10+left;i++){
                        if(game.map[i]!=0)num++;
                    }
                    return ++num;
                 }
                function removePz(){
                    $(".map").children().eq(getIndex()).remove();
                     game.map[top*10+left]=0;
                }
            },
            keypack:[0,0,0],
            draw_message:function(){
               $(".message ._11 span").html(this.pcAttr[0]);
               $(".message ._22 span").html(this.pcAttr[1]);
               $(".message ._33 span").html(this.pcAttr[2]);
               $(".message ._44 span").html(this.pcAttr[3]);
               $(".message ._1 span").html(this.keypack[0]);
               $(".message ._2 span").html(this.keypack[1]);
               $(".message ._3 span").html(this.keypack[2]);
            }

        }
        game.exe();
    });    
</script>
 </body>
</html>